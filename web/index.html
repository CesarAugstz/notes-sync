<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
  </head>
  <body>
    <main>
      <div class="content-container">
        <div class="input-section">
          <textarea class="main-input" type="text" id="input"> </textarea>
        </div>
        <div class="file-section">
          <div class="file-controls">
            <input type="file" id="fileInput" multiple style="display: none" />
            <button id="uploadBtn" class="upload-btn">üìÅ Add Files</button>
          </div>
          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-content">
              <p>üìé Drop files here or click "Add Files"</p>
            </div>
          </div>
          <div class="file-list" id="fileList">
            <h3>Uploaded Files</h3>
            <div id="fileItems"></div>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>

<script>
  const input = document.getElementById('input')
  const fileInput = document.getElementById('fileInput')
  const uploadBtn = document.getElementById('uploadBtn')
  const dropZone = document.getElementById('dropZone')
  const fileList = document.getElementById('fileList')
  const fileItems = document.getElementById('fileItems')
  const deleteBtns = document.querySelectorAll('.delete-btn')

  const url = 'http://192.168.1.225:42060'
  const noteName = window.location.pathname.split('/')[1] || ''
  const randomStrings = ['banana', 'totem']

  if (!noteName) {
    window.location.href =
      '/' + randomStrings[Math.floor(Math.random() * randomStrings.length)]
  }

  let uploadedFiles = []

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
  }

  function createFileItem(file, status = 'uploading') {
    const fileItem = document.createElement('div')
    fileItem.className = 'file-item'
    fileItem.innerHTML = `
      <div class="file-status ${status}">
        ${status === 'uploading' ? '‚è≥' : status === 'success' ? '‚úÖ' : '‚ùå'}
      </div>
      <div class="file-info">
        <span class="file-name">name: ${file.name}</span>
        <span class="file-size">size: ${formatFileSize(file.size)}</span>
        <span class="file-size">mime: ${file.mimeType}</span>
      </div>
      <button class="download-btn" data-id="${file.id}">‚¨áÔ∏è</button>
      <button class="delete-btn"  data-id="${file.id}">‚ùå</button>
    `

    fileItem.querySelector('.download-btn').addEventListener('click', () => {
      window.open(url + '/file/' + file.id, '_blank')
    })
    fileItem.querySelector('.delete-btn').addEventListener('click', () => {
      deleteFile(file.id)
    })
    return fileItem
  }

  async function uploadFile(file) {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('noteName', noteName)

    const fileItem = createFileItem(file, 'uploading')
    fileItems.appendChild(fileItem)
    console.log('Uploading file:', formData)

    try {
      const response = await fetch(url + '/upload', {
        method: 'POST',
        body: formData,
      })

      if (response.ok) {
        fileItem.querySelector('.file-status').className = 'file-status success'
        fileItem.querySelector('.file-status').textContent = '‚úÖ'
        uploadedFiles.push(file)
        console.log('File uploaded successfully:', file.name)
      } else {
        throw new Error('Upload failed')
      }
    } catch (error) {
      fileItem.querySelector('.file-status').className = 'file-status error'
      fileItem.querySelector('.file-status').textContent = '‚ùå'
      console.error('Error uploading file:', file.name, error)
    }
  }

  function handleFiles(files) {
    Array.from(files).forEach(file => {
      uploadFile(file)
    })
  }

  uploadBtn.addEventListener('click', () => {
    fileInput.click()
  })

  fileInput.addEventListener('change', e => {
    if (e.target.files.length > 0) {
      handleFiles(e.target.files)
    }
  })

  document.addEventListener('dragover', e => {
    e.preventDefault()
    document.body.classList.add('drag-over')
  })

  document.addEventListener('dragleave', e => {
    e.preventDefault()
    if (e.clientX === 0 && e.clientY === 0) {
      document.body.classList.remove('drag-over')
    }
  })

  document.addEventListener('drop', e => {
    e.preventDefault()
    document.body.classList.remove('drag-over')

    const files = e.dataTransfer.files
    if (files.length > 0) {
      handleFiles(files)
    }
  })

  async function save(value) {
    try {
      await fetch(url + '/note/' + noteName, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: value }),
      })
      console.log('saved')
    } catch (error) {
      console.error('error on save', error)
    }
  }

  async function getData() {
    try {
      async function fetchNoteText() {
        const response = await fetch(url + '/note/' + noteName)
        console.log('response', response)
        const data = await response.json()
        console.log('data', data)
        if (data.content && data.content !== input.value) {
          input.value = data.content
        }
      }

      async function getFiles() {
        const response = await fetch(url + '/files/' + noteName)
        const { files } = await response.json()
        console.log('files', files)
        fileItems.innerHTML = ''
        for (const file of files) {
          const formatted = {
            name: file.original_name,
            id: file.id,
            size: file.file_size,
            mimeType: file.mime_type,
          }
          const fileItem = createFileItem(formatted, 'success')
          fileItems.appendChild(fileItem)
        }
      }

      await Promise.all([fetchNoteText(), getFiles()])
    } catch (error) {
      console.error('error on getdata', error)
    }
  }

  async function downloadFile(id) {
    try {
      console.log('download file', id)
      if (!id) return
      const response = await fetch(url + '/file/' + id)

      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = id
      a.click()
    } catch (error) {
      console.error('error on download', error)
    }
  }

  async function deleteFile(id) {
    try {
      console.log('delete file', id)
      if (!id) return
      await fetch(url + '/file/' + id, {
        method: 'DELETE',
      })
      console.log('file deleted')
      await getData()
    } catch (error) {
      console.error('error on delete', error)
    }
  }

  setInterval(async () => {
    await getData()
  }, 3000)

  window.onload = async () => {
    await getData()
  }

  async function onInputEvent(event) {
    try {
      console.log('keydown')
      if (timer) {
        clearTimeout(timer)
      }
      timer = setTimeout(async () => {
        console.log('saving')
        await save(input.value)
      }, 1000)
    } catch (error) {
      console.error(error.message)
    }
  }

  var timer = null
  input.addEventListener('input', async event => {
    await onInputEvent(event)
  })
  input.addEventListener('change', async event => {
    await onInputEvent(event)
  })
  input.addEventListener('keydown', async event => {
    await onInputEvent(event)
  })
</script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family:
      -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  main {
    width: 100vw;
    height: 100vh;
  }

  .content-container {
    display: flex;
    height: 100vh;
  }

  .input-section {
    flex: 1;
    min-width: 0;
  }

  .main-input {
    width: 100%;
    height: 100%;
    font-size: 20px;
    border: none;
    outline: none;
    resize: none;
    padding: 10px;
    box-sizing: border-box;
  }

  .file-section {
    width: 300px;
    background: #f8f9fa;
    border-left: 1px solid #e9ecef;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .file-controls {
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
  }

  .upload-btn {
    width: 100%;
    padding: 10px 15px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  .upload-btn:hover {
    background: #0056b3;
  }

  .drop-zone {
    margin: 15px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: white;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .drop-zone.drag-over {
    border-color: #007bff;
    background: #f0f8ff;
  }

  .drop-zone-content p {
    margin: 0;
    color: #666;
    font-size: 14px;
  }

  .file-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
  }

  .file-list h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 10px;
  }

  .file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    background: white;
    border-radius: 5px;
    border: 1px solid #e9ecef;
  }

  .file-info {
    flex: 1;
    min-width: 0;
  }

  .file-name {
    display: block;
    font-weight: 500;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
  }

  .file-size {
    display: block;
    font-size: 12px;
    color: #666;
    margin-top: 2px;
  }

  .file-status {
    margin-left: 10px;
    font-size: 16px;
  }

  .file-status.uploading {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
    100% {
      opacity: 1;
    }
  }

  body.drag-over {
    background: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .content-container {
      flex-direction: column;
    }

    .input-section {
      flex: 1;
      min-height: 60%;
    }

    .file-section {
      width: 100%;
      height: 40%;
      border-left: none;
      border-top: 1px solid #e9ecef;
    }

    .file-list {
      max-height: 200px;
    }

    .main-input {
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }

  @media (max-width: 480px) {
    .drop-zone {
      margin: 10px;
      padding: 15px;
    }

    .file-controls {
      padding: 10px;
    }

    .file-list {
      padding: 10px;
    }
  }
</style>
