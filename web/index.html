<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="./style.css" />
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
  </head>
  <body>
    <main>
      <div class="content-container">
        <div class="input-section">
          <textarea class="main-input" type="text" id="input"> </textarea>
        </div>
        <div class="file-section">
          <div class="file-controls">
            <input type="file" id="fileInput" multiple style="display: none" />
            <button id="uploadBtn" class="upload-btn">üìÅ Add Files</button>
          </div>
          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-content">
              <p>üìé Drop files here or click "Add Files"</p>
            </div>
          </div>
          <div class="file-list" id="fileList">
            <h3>Uploaded Files</h3>
            <div id="fileItems"></div>
          </div>
        </div>
      </div>
    </main>
    <div id="toast-container"></div>
  </body>
</html>

<script>
  const input = document.getElementById('input')
  const fileInput = document.getElementById('fileInput')
  const uploadBtn = document.getElementById('uploadBtn')
  const dropZone = document.getElementById('dropZone')
  const fileList = document.getElementById('fileList')
  const fileItems = document.getElementById('fileItems')
  const deleteBtns = document.querySelectorAll('.delete-btn')
  let apiData = ''

  var inputTimerToSave = null
  var inputTimerToGetData = null
  let isTyping = false
  let isUploading = false

  const noteName = window.location.pathname.split('/')[1] || ''
  const randomStrings = ['banana', 'totem']

  if (!noteName) {
    window.location.href =
      '/' + randomStrings[Math.floor(Math.random() * randomStrings.length)]
  }

  let uploadedFiles = []

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
  }

  function createFileItem(file, status = 'uploading') {
    const fileItem = document.createElement('div')
    fileItem.className = 'file-item'
    fileItem.innerHTML = `
      <div class="file-status ${status}">
        ${status === 'uploading' ? '‚è≥' : status === 'success' ? '‚úÖ' : '‚ùå'}
      </div>
      <div class="file-info">
        <span class="file-name">name: ${file.name}</span>
        <span class="file-size">size: ${formatFileSize(file.size)}</span>
        <span class="file-size">mime: ${file.mimeType}</span>
      </div>
      <button class="download-btn" data-id="${file.id}">‚¨áÔ∏è</button>
      <button class="delete-btn"  data-id="${file.id}">‚ùå</button>
    `

    fileItem.querySelector('.download-btn').addEventListener('click', () => {
      downloadFile(file.id)
    })
    fileItem.querySelector('.delete-btn').addEventListener('click', () => {
      deleteFile(file.id)
    })
    return fileItem
  }

  async function uploadFile(file) {
    isUploading = true
    const formData = new FormData()
    formData.append('file', file)
    formData.append('noteName', noteName)
    const fileItem = createFileItem(file, 'uploading')
    fileItems.appendChild(fileItem)
    try {
      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      })
      if (response.ok) {
        fileItem.querySelector('.file-status').className = 'file-status success'
        fileItem.querySelector('.file-status').textContent = '‚úÖ'
        uploadedFiles.push(file)
        showToast('success', `File '${file.name}' uploaded!`)
      } else {
        throw new Error('Upload failed')
      }
    } catch (error) {
      fileItem.querySelector('.file-status').className = 'file-status error'
      fileItem.querySelector('.file-status').textContent = '‚ùå'
      showToast('error', `Upload failed for '${file.name}'.`)
      console.error('Error uploading file:', file.name, error)
    } finally {
      isUploading = false
    }
  }

  function handleFiles(files) {
    Array.from(files).forEach(file => {
      uploadFile(file)
    })
  }

  uploadBtn.addEventListener('click', () => {
    fileInput.click()
  })

  fileInput.addEventListener('change', e => {
    if (e.target.files.length > 0) {
      handleFiles(e.target.files)
    }
  })

  document.addEventListener('dragover', e => {
    e.preventDefault()
    document.body.classList.add('drag-over')
  })

  document.addEventListener('dragleave', e => {
    e.preventDefault()
    if (e.clientX === 0 && e.clientY === 0) {
      document.body.classList.remove('drag-over')
    }
  })

  document.addEventListener('drop', e => {
    e.preventDefault()
    document.body.classList.remove('drag-over')

    const files = e.dataTransfer.files
    if (files.length > 0) {
      handleFiles(files)
    }
  })

  async function save(value) {
    try {
      console.log('apidata value', value, apiData)
      if (apiData === value) return
      await fetch('/api/note/' + noteName, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: value }),
      })
      console.log('saved')
      showToast('success', 'Note saved successfully!')
    } catch (error) {
      console.error('error on save', error)
    }
  }

  async function getData() {
    try {
      async function fetchNoteText() {
        const response = await fetch('/api/note/' + noteName)
        console.log('response', response)
        const data = await response.json()
        console.log('data', data)
        apiData = data.content
        if (data.content && data.content !== input.value) {
          input.value = data.content
        }
      }

      async function getFiles() {
        const response = await fetch('/api/files/' + noteName)
        const { files } = await response.json()
        console.log('files', files)
        fileItems.innerHTML = ''
        for (const file of files) {
          const formatted = {
            name: file.original_name,
            id: file.id,
            size: file.file_size,
            mimeType: file.mime_type,
          }
          const fileItem = createFileItem(formatted, 'success')
          fileItems.appendChild(fileItem)
        }
      }

      await Promise.all([fetchNoteText(), getFiles()])
    } catch (error) {
      console.error('error on getdata', error)
    }
  }

  async function downloadFile(id) {
    try {
      console.log('download file', id)
      if (!id) return
      const response = await fetch('/api/file/' + id)

      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = id
      a.click()
    } catch (error) {
      console.error('error on download', error)
    }
  }

  async function deleteFile(id) {
    try {
      if (!id) return
      await fetch('/api/file/' + id, { method: 'DELETE' })
      showToast('info', 'File deleted.')
      await getData()
    } catch (error) {
      showToast('error', 'Error deleting file.')
      console.error('error on delete', error)
    }
  }

  setInterval(async () => {
    if (isTyping) return
    if (isUploading) return

    await getData()
  }, 3000)

  window.onload = async () => {
    await getData()
  }

  async function onInputEvent(event) {
    try {
      isTyping = true
      console.log('keydown')
      if (inputTimerToSave) clearTimeout(inputTimerToSave)
      if (inputTimerToGetData) clearTimeout(inputTimerToGetData)

      inputTimerToSave = setTimeout(async () => {
        console.log('saving')
        isTyping = false
        await save(input.value)
      }, 1000)
    } catch (error) {
      console.error(error.message)
    }
  }

  input.addEventListener('input', async event => {
    await onInputEvent(event)
  })
  input.addEventListener('change', async event => {
    await onInputEvent(event)
  })
  input.addEventListener('keydown', async event => {
    await onInputEvent(event)
  })

  function showToast(type, message) {
    const toastContainer = document.getElementById('toast-container')
    const toast = document.createElement('div')
    toast.className = `toast ${type}`
    toast.textContent = message
    toastContainer.appendChild(toast)

    console.log({toastContainer, toast, className: toast.className, textContent: toast.textContent })
    setTimeout(() => {
      toast.classList.add('show')
    }, 10)
    setTimeout(() => {
      toast.classList.remove('show')
      setTimeout(() => {
        toast.remove()
      }, 500)
    }, 3000)
  }
</script>
